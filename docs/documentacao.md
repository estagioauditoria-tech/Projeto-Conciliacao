# üìö Documenta√ß√£o T√©cnica - Conciliador Financeiro v2

> Documenta√ß√£o completa do sistema de concilia√ß√£o financeira automatizada

---

## √çndice

1. [Vis√£o Geral](#vis√£o-geral)
2. [Arquitetura do Sistema](#arquitetura-do-sistema)
3. [Modelos de Dados](#modelos-de-dados)
4. [Camada de Servi√ßos](#camada-de-servi√ßos)
5. [Interface do Usu√°rio](#interface-do-usu√°rio)
6. [Fluxo de Dados](#fluxo-de-dados)
7. [Guia de Desenvolvimento](#guia-de-desenvolvimento)
8. [API de Refer√™ncia](#api-de-refer√™ncia)
9. [Exemplos de Uso](#exemplos-de-uso)
10. [Troubleshooting](#troubleshooting)

---

## Vis√£o Geral

### Objetivo do Projeto

O Conciliador Financeiro v2 √© um sistema desktop desenvolvido em Python para automatizar o processo de concilia√ß√£o de transa√ß√µes financeiras. O sistema processa planilhas Excel de m√∫ltiplas fontes, normaliza os dados e gera relat√≥rios padronizados.

### Problema Resolvido

Empresas que lidam com m√∫ltiplas formas de pagamento (PIX, Cart√£o, Dinheiro, etc.) precisam consolidar dados de diferentes sistemas em formatos espec√≠ficos (ex: Omie ERP). Este processo manual pode levar horas e est√° sujeito a erros humanos.

### Solu√ß√£o Proposta

Sistema automatizado que:
- Importa planilhas de diferentes fontes
- Normaliza e valida dados automaticamente
- Classifica transa√ß√µes por tipo de pagamento
- Gera relat√≥rios no formato desejado
- Mant√©m hist√≥rico de opera√ß√µes

### Benef√≠cios Quantific√°veis

- **Redu√ß√£o de tempo**: De 3 horas para ~5 minutos
- **Precis√£o**: Elimina√ß√£o de erros de digita√ß√£o/c√≥pia
- **Escalabilidade**: Processa m√∫ltiplos arquivos simultaneamente
- **Rastreabilidade**: Hist√≥rico completo de opera√ß√µes

---

## Arquitetura do Sistema

### Princ√≠pios de Design

O sistema segue os princ√≠pios **SOLID** com √™nfase em:

1. **Single Responsibility Principle (SRP)**: Cada classe/m√≥dulo tem uma √∫nica responsabilidade
2. **Dependency Inversion**: M√≥dulos de alto n√≠vel n√£o dependem de implementa√ß√µes espec√≠ficas
3. **Separation of Concerns**: Frontend, Backend e Dados completamente separados

### Arquitetura em Camadas

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          CAMADA DE APRESENTA√á√ÉO (UI)           ‚îÇ
‚îÇ  - Interface gr√°fica (CustomTkinter)           ‚îÇ
‚îÇ  - Intera√ß√£o com usu√°rio                        ‚îÇ
‚îÇ  - Feedback visual                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         CAMADA DE SERVI√áOS (Business Logic)    ‚îÇ
‚îÇ  - Processamento de dados                       ‚îÇ
‚îÇ  - Regras de neg√≥cio                            ‚îÇ
‚îÇ  - Transforma√ß√µes e valida√ß√µes                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ           CAMADA DE MODELOS (Data)             ‚îÇ
‚îÇ  - Defini√ß√£o de estruturas de dados            ‚îÇ
‚îÇ  - Valida√ß√µes b√°sicas                           ‚îÇ
‚îÇ  - Serializa√ß√£o                                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                        ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ          CAMADA DE PERSIST√äNCIA                ‚îÇ
‚îÇ  - Banco de dados SQLite                        ‚îÇ
‚îÇ  - Hist√≥rico de opera√ß√µes                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Estrutura de Diret√≥rios

```
src/conciliador/
‚îÇ
‚îú‚îÄ‚îÄ models/                      # CAMADA DE DADOS
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ transaction.py           # Modelo de transa√ß√£o financeira
‚îÇ   ‚îî‚îÄ‚îÄ template.py              # Modelo de template de sa√≠da
‚îÇ
‚îú‚îÄ‚îÄ services/                    # CAMADA DE NEG√ìCIO
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ file_handler.py          # Gerencia importa√ß√£o/exporta√ß√£o
‚îÇ   ‚îú‚îÄ‚îÄ sheet_processor.py       # Processa e limpa planilhas
‚îÇ   ‚îú‚îÄ‚îÄ data_mapper.py           # Mapeia dados para Transaction
‚îÇ   ‚îî‚îÄ‚îÄ template_manager.py      # Gerencia templates de sa√≠da
‚îÇ
‚îú‚îÄ‚îÄ ui/                          # CAMADA DE APRESENTA√á√ÉO
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ main_window.py           # Janela principal da aplica√ß√£o
‚îÇ   ‚îî‚îÄ‚îÄ styles.py                # Estilos e temas visuais
‚îÇ
‚îú‚îÄ‚îÄ utils/                       # UTILIT√ÅRIOS
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îî‚îÄ‚îÄ validators.py            # Fun√ß√µes de valida√ß√£o
‚îÇ
‚îî‚îÄ‚îÄ database.py                  # CAMADA DE PERSIST√äNCIA
```

---

## Modelos de Dados

### Transaction (models/transaction.py)

**Responsabilidade**: Representar uma √∫nica transa√ß√£o financeira

**Estrutura**:

```python
Transaction:
    - data: datetime | str          # Data da transa√ß√£o
    - valor: float                  # Valor monet√°rio
    - tipo_pagamento: str           # PIX, Cart√£o, Dinheiro, etc.
    - extras: dict                  # Campos adicionais vari√°veis
```

**N√∫cleo R√≠gido (Obrigat√≥rio)**:
- `data`: Data/hora da transa√ß√£o
- `valor`: Valor em decimal (sempre positivo)
- `tipo_pagamento`: M√©todo de pagamento utilizado

**Campos Flex√≠veis (Opcionais)**:
- `extras`: Dicion√°rio com campos espec√≠ficos de cada fonte de dados
  - Exemplos: `cliente`, `nota_fiscal`, `placa_veiculo`, `cnpj`, etc.

**Valida√ß√µes**:
- Valor deve ser > 0
- Tipo de pagamento deve estar em lista pr√©-definida
- Data n√£o pode ser vazia

**M√©todos**:
- `to_dict()`: Serializa para dicion√°rio
- `_validar()`: Valida dados internos (privado)

### Template (models/template.py)

**Responsabilidade**: Definir estrutura de templates de sa√≠da

**Estrutura**:

```python
Template:
    - nome: str                     # Nome do template (ex: "Omie", "Custom")
    - colunas: list[str]            # Lista de colunas esperadas
    - mapeamento: dict              # Mapeamento de campos Transaction ‚Üí Template
    - formatacao: dict              # Regras de formata√ß√£o
```

**Atributos**:
- `nome`: Identificador √∫nico do template
- `colunas`: Lista ordenada de colunas da planilha final
- `mapeamento`: Como campos de Transaction viram colunas do template
- `formatacao`: Regras de estilo (cores, larguras, etc.)

**Exemplo de Mapeamento**:
```python
{
    "Data": "data",                    # Coluna "Data" vem de transaction.data
    "Valor": "valor",
    "Forma de Pagamento": "tipo_pagamento"
}
```

---

## Camada de Servi√ßos

### FileHandler (services/file_handler.py)

**Responsabilidade**: Gerenciar importa√ß√£o e exporta√ß√£o de arquivos

**Fun√ß√µes Principais**:

1. `importar_planilha(caminho: str) -> pd.DataFrame`
   - L√™ arquivo Excel/CSV
   - Retorna DataFrame do Pandas
   - Suporta: .xlsx, .xls, .csv

2. `exportar_planilha(df: pd.DataFrame, caminho: str, template: Template)`
   - Gera arquivo Excel formatado
   - Aplica estilos do template
   - Salva em disco

**Depend√™ncias**: Pandas, OpenPyXL

### SheetProcessor (services/sheet_processor.py)

**Responsabilidade**: Limpar e normalizar planilhas

**Pipeline de Processamento**:

```
Entrada: DataFrame bruto (c√©lulas mescladas, formata√ß√£o inconsistente)
    ‚Üì
1. Desmesclar c√©lulas (preencher valores)
2. Remover linhas/colunas vazias
3. Identificar linha de cabe√ßalho
4. Padronizar tipos de dados
5. Remover caracteres especiais
    ‚Üì
Sa√≠da: DataFrame normalizado e limpo
```

**Fun√ß√µes**:
- `limpar_planilha(df: pd.DataFrame) -> pd.DataFrame`
- `desmesclar_celulas(df: pd.DataFrame) -> pd.DataFrame`
- `identificar_cabecalho(df: pd.DataFrame) -> int`
- `padronizar_tipos(df: pd.DataFrame) -> pd.DataFrame`

### DataMapper (services/data_mapper.py)

**Responsabilidade**: Converter DataFrame em lista de Transactions

**Processo**:

```python
DataFrame (planilha limpa)
    ‚Üì
Para cada linha:
    1. Extrair campos obrigat√≥rios (data, valor, tipo)
    2. Extrair campos extras (demais colunas)
    3. Criar Transaction(data, valor, tipo, **extras)
    4. Validar (Transaction faz valida√ß√£o)
    5. Adicionar √† lista ou registrar erro
    ‚Üì
Lista de Transactions v√°lidas + Lista de erros
```

**Fun√ß√µes**:
- `extrair_transactions(df: pd.DataFrame) -> tuple[list[Transaction], list[str]]`
- `identificar_colunas(df: pd.DataFrame) -> dict`
- `classificar_tipo_pagamento(descricao: str) -> str`

### TemplateManager (services/template_manager.py)

**Responsabilidade**: Gerar planilhas formatadas a partir de Transactions

**Processo**:

```
Lista de Transactions + Template
    ‚Üì
1. Criar DataFrame vazio com colunas do template
2. Para cada Transaction:
    - Mapear campos usando template.mapeamento
    - Adicionar linha ao DataFrame
3. Aplicar formata√ß√£o (cores, estilos)
4. Exportar para Excel
    ‚Üì
Arquivo Excel formatado
```

**Fun√ß√µes**:
- `gerar_planilha(transactions: list[Transaction], template: Template) -> str`
- `aplicar_formatacao(wb: Workbook, template: Template)`
- `carregar_template(nome: str) -> Template`

---

## Interface do Usu√°rio

### Tecnologia: CustomTkinter

**Por que CustomTkinter?**
- Interface moderna e profissional
- Suporte a temas (dark/light)
- Widgets customiz√°veis
- Compatibilidade com Tkinter tradicional

### Layout da Janela Principal

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  [LOGO]  Conciliador Financeiro v2          [‚öôÔ∏è Config]    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ              ‚îÇ                        ‚îÇ                     ‚îÇ
‚îÇ  PAINEL      ‚îÇ    √ÅREA CENTRAL        ‚îÇ   HIST√ìRICO        ‚îÇ
‚îÇ  LATERAL     ‚îÇ                        ‚îÇ                     ‚îÇ
‚îÇ              ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ  [ Config ]  ‚îÇ  ‚îÇ                  ‚îÇ  ‚îÇ  ‚îÇ 02/10 10:30   ‚îÇ ‚îÇ
‚îÇ  [ Sobre  ]  ‚îÇ  ‚îÇ   [üìÅ IMPORTAR]  ‚îÇ  ‚îÇ  ‚îÇ arquivo1.xlsx ‚îÇ ‚îÇ
‚îÇ              ‚îÇ  ‚îÇ                  ‚îÇ  ‚îÇ  ‚îÇ ‚úÖ Sucesso    ‚îÇ ‚îÇ
‚îÇ              ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ  ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
‚îÇ              ‚îÇ                        ‚îÇ  ‚îÇ 01/10 15:45   ‚îÇ ‚îÇ
‚îÇ              ‚îÇ  Status: Aguardando... ‚îÇ  ‚îÇ arquivo2.xlsx ‚îÇ ‚îÇ
‚îÇ              ‚îÇ                        ‚îÇ  ‚îÇ ‚úÖ Sucesso    ‚îÇ ‚îÇ
‚îÇ              ‚îÇ                        ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ              ‚îÇ                        ‚îÇ                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### Dimens√µes
- Resolu√ß√£o: 1366x720 (otimizada para laptops)
- Layout: Grid 3 colunas (350px | flex | 450px)

### Tema
- Fundo principal: `#161616` (preto suave)
- Pain√©is: `#333333` (cinza escuro)
- Bot√£o importar: `#004D40` (verde escuro)
- Bot√£o config: `#810B0B` (vermelho escuro)
- Texto: `#FFFFFF` (branco)

---

## Fluxo de Dados

### Fluxo Completo de Processamento

```
1. USU√ÅRIO
   ‚Üì (clica em "Importar")

2. UI (main_window.py)
   ‚Üì (abre dialog, seleciona arquivo)

3. FileHandler.importar_planilha(caminho)
   ‚Üì (l√™ Excel ‚Üí DataFrame)

4. SheetProcessor.limpar_planilha(df)
   ‚Üì (normaliza dados)

5. DataMapper.extrair_transactions(df)
   ‚Üì (cria Transactions, valida)

6. TemplateManager.gerar_planilha(transactions, template)
   ‚Üì (gera Excel formatado)

7. Database.registrar_historico(...)
   ‚Üì (salva no SQLite)

8. UI atualiza interface
   ‚Üì (mostra sucesso/erro)

9. USU√ÅRIO v√™ resultado
```

### Fluxo de Valida√ß√£o

```
DataFrame (dados brutos)
    ‚Üì
DataMapper tenta criar Transaction
    ‚Üì
Transaction.__init__ valida dados
    ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Dados v√°lidos?  ‚îÇ Dados inv√°lidos ‚îÇ
‚îÇ      SIM        ‚îÇ      N√ÉO        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚Üì                  ‚Üì
  Transaction criada   ValueError lan√ßado
         ‚Üì                  ‚Üì
  Adicionada √† lista   Erro registrado
         ‚Üì                  ‚Üì
  Processamento OK    Usu√°rio notificado
```

---

## Guia de Desenvolvimento

### Configura√ß√£o do Ambiente

**1. Requisitos**:
- Python 3.8+
- pip
- virtualenv (recomendado)

**2. Instala√ß√£o**:
```bash
# Clonar reposit√≥rio
git clone <repo-url>
cd conciliador-financeiro

# Criar ambiente virtual
python -m venv venv

# Ativar ambiente
# Windows:
venv\Scripts\activate
# Linux/Mac:
source venv/bin/activate

# Instalar depend√™ncias
pip install -r requirements.txt
```

**3. Estrutura de Branches**:
```
main                    # Produ√ß√£o (est√°vel)
‚îú‚îÄ‚îÄ develop/v2         # Desenvolvimento ativo
‚îÇ   ‚îú‚îÄ‚îÄ feature/*      # Novas funcionalidades
‚îÇ   ‚îú‚îÄ‚îÄ fix/*          # Corre√ß√µes de bugs
‚îÇ   ‚îî‚îÄ‚îÄ refactor/*     # Refatora√ß√µes
‚îî‚îÄ‚îÄ develop/v1         # C√≥digo legado (backup)
```

### Fluxo de Trabalho (Workflow)

**1. Criar Nova Funcionalidade**:
```bash
git checkout develop/v2
git pull origin develop/v2
git checkout -b feature/nome-funcionalidade

# Desenvolver...
git add .
git commit -m "feat: descri√ß√£o da funcionalidade"
git push origin feature/nome-funcionalidade

# Abrir Pull Request para develop/v2
```

**2. Padr√£o de Commits (Conventional Commits)**:
- `feat:` - Nova funcionalidade
- `fix:` - Corre√ß√£o de bug
- `refactor:` - Refatora√ß√£o sem mudar comportamento
- `docs:` - Documenta√ß√£o
- `test:` - Testes
- `chore:` - Manuten√ß√£o/build

**Exemplos**:
```bash
git commit -m "feat: adiciona valida√ß√£o de CPF em Transaction"
git commit -m "fix: corrige bug de c√©lulas mescladas"
git commit -m "refactor: separa l√≥gica de UI em main_window"
git commit -m "docs: atualiza documenta√ß√£o da API"
```

### Ordem de Implementa√ß√£o (Bottom-Up)

**Fase 1 - Funda√ß√£o (Models)**:
1. `models/transaction.py` ‚Üê **COME√áAR AQUI**
2. `models/template.py`
3. Testar models isoladamente

**Fase 2 - L√≥gica de Neg√≥cio (Services)**:
4. `services/file_handler.py`
5. `services/sheet_processor.py`
6. `services/data_mapper.py`
7. `services/template_manager.py`
8. Testar cada service com models prontos

**Fase 3 - Interface (UI)**:
9. `ui/main_window.py`
10. `ui/styles.py`
11. Integrar com services

**Fase 4 - Persist√™ncia**:
12. `database.py`
13. Integra√ß√£o final

### Boas Pr√°ticas

**1. Documenta√ß√£o**:
```python
def extrair_transactions(df: pd.DataFrame) -> list[Transaction]:
    """
    Extrai objetos Transaction de um DataFrame.

    Args:
        df: DataFrame limpo e normalizado

    Returns:
        Lista de objetos Transaction v√°lidos

    Raises:
        ValueError: Se DataFrame n√£o tiver colunas obrigat√≥rias
    """
    pass
```

**2. Type Hints**:
```python
from typing import List, Dict, Optional

def processar(arquivo: str) -> Dict[str, any]:
    transactions: List[Transaction] = []
    erros: List[str] = []
    # ...
```

**3. Valida√ß√µes**:
```python
# ‚ùå N√£o fazer:
def criar_transaction(valor):
    return Transaction(valor=valor)

# ‚úÖ Fazer:
def criar_transaction(valor: float) -> Transaction:
    if valor <= 0:
        raise ValueError(f"Valor inv√°lido: {valor}")
    return Transaction(valor=valor)
```

**4. Separa√ß√£o de Responsabilidades**:
```python
# ‚ùå Transaction "inteligente" (faz muita coisa):
class Transaction:
    def salvar_no_banco(self):
        # N√ÉO!

# ‚úÖ Transaction "burra" (s√≥ dados):
class Transaction:
    def to_dict(self) -> dict:
        return {...}
```

---

## API de Refer√™ncia

### models.transaction.Transaction

```python
class Transaction:
    def __init__(
        self,
        data: Union[str, datetime],
        valor: float,
        tipo_pagamento: str,
        **extras: dict
    ):
        """
        Cria uma transa√ß√£o financeira.

        Args:
            data: Data da transa√ß√£o (str ou datetime)
            valor: Valor monet√°rio (deve ser > 0)
            tipo_pagamento: M√©todo de pagamento
            **extras: Campos adicionais opcionais

        Raises:
            ValueError: Se valida√ß√£o falhar
        """

    def to_dict(self) -> dict:
        """Retorna representa√ß√£o em dicion√°rio"""

    def _validar(self) -> None:
        """Valida dados internos (privado)"""
```

### services.file_handler

```python
def importar_planilha(caminho: str) -> pd.DataFrame:
    """
    Importa planilha Excel/CSV.

    Args:
        caminho: Caminho do arquivo

    Returns:
        DataFrame com dados da planilha

    Raises:
        FileNotFoundError: Se arquivo n√£o existe
        ValueError: Se formato inv√°lido
    """

def exportar_planilha(
    df: pd.DataFrame,
    caminho: str,
    template: Template
) -> str:
    """
    Exporta DataFrame para Excel formatado.

    Args:
        df: DataFrame a exportar
        caminho: Caminho de sa√≠da
        template: Template de formata√ß√£o

    Returns:
        Caminho do arquivo gerado
    """
```

### services.data_mapper

```python
def extrair_transactions(
    df: pd.DataFrame
) -> Tuple[List[Transaction], List[str]]:
    """
    Converte DataFrame em Transactions.

    Args:
        df: DataFrame limpo

    Returns:
        Tupla (lista de Transactions, lista de erros)
    """

def classificar_tipo_pagamento(descricao: str) -> str:
    """
    Identifica tipo de pagamento por descri√ß√£o.

    Args:
        descricao: Texto descritivo

    Returns:
        Tipo de pagamento (PIX, Cart√£o, etc.)
    """
```

---

## Exemplos de Uso

### Exemplo 1: Criar Transaction Manualmente

```python
from models.transaction import Transaction
from datetime import datetime

# Criar transa√ß√£o
t = Transaction(
    data=datetime(2025, 10, 2),
    valor=150.50,
    tipo_pagamento="PIX",
    cliente="Jo√£o Silva",
    nota_fiscal="NF-12345"
)

# Acessar dados
print(t.valor)  # 150.5
print(t.extras['cliente'])  # "Jo√£o Silva"

# Serializar
dados = t.to_dict()
print(dados)
# {'data': datetime(...), 'valor': 150.5, 'tipo_pagamento': 'PIX', ...}
```

### Exemplo 2: Processar Planilha Completa

```python
from services.file_handler import importar_planilha
from services.sheet_processor import limpar_planilha
from services.data_mapper import extrair_transactions

# 1. Importar
df = importar_planilha("vendas_outubro.xlsx")

# 2. Limpar
df_limpo = limpar_planilha(df)

# 3. Extrair transactions
transactions, erros = extrair_transactions(df_limpo)

print(f"‚úÖ {len(transactions)} transa√ß√µes v√°lidas")
print(f"‚ùå {len(erros)} erros encontrados")

if erros:
    for erro in erros:
        print(f"  - {erro}")
```

### Exemplo 3: Gerar Planilha Omie

```python
from services.template_manager import gerar_planilha, carregar_template

# Carregar template Omie
template_omie = carregar_template("omie")

# Gerar planilha
arquivo_saida = gerar_planilha(
    transactions=transactions,
    template=template_omie,
    caminho_saida="relatorio_omie_outubro.xlsx"
)

print(f"‚úÖ Planilha gerada: {arquivo_saida}")
```

### Exemplo 4: Valida√ß√£o de Dados

```python
from models.transaction import Transaction

# Tentar criar transa√ß√£o inv√°lida
try:
    t = Transaction(
        data="02/10/2025",
        valor=-100,  # ‚ùå Valor negativo
        tipo_pagamento="PIX"
    )
except ValueError as e:
    print(f"Erro: {e}")
    # Sa√≠da: "Erro: Valor deve ser positivo"
```

---

## Troubleshooting

### Problemas Comuns

#### 1. Erro: "ModuleNotFoundError: No module named 'customtkinter'"

**Causa**: Depend√™ncias n√£o instaladas

**Solu√ß√£o**:
```bash
pip install -r requirements.txt
# ou
pip install customtkinter
```

#### 2. Erro: "C√©lulas mescladas n√£o processadas"

**Causa**: Planilha com formata√ß√£o complexa

**Solu√ß√£o**:
```python
# Usar SheetProcessor antes de processar
df_limpo = sheet_processor.desmesclar_celulas(df)
```

#### 3. Erro: "ValueError: Tipo de pagamento inv√°lido"

**Causa**: Tipo n√£o est√° na lista de aceitos

**Solu√ß√£o**:
```python
# Adicionar tipo em models/transaction.py
TIPOS_VALIDOS = ['PIX', 'Cart√£o', 'Dinheiro', 'Boleto', 'NOVO_TIPO']
```

#### 4. Interface n√£o abre / Tela preta

**Causa**: Problema com CustomTkinter ou tema

**Solu√ß√£o**:
```bash
# Reinstalar customtkinter
pip uninstall customtkinter
pip install customtkinter --upgrade
```

#### 5. Planilha gerada sem formata√ß√£o

**Causa**: Template n√£o aplicado corretamente

**Solu√ß√£o**:
```python
# Verificar se template tem atributo 'formatacao'
print(template.formatacao)

# Aplicar manualmente se necess√°rio
template_manager.aplicar_formatacao(workbook, template)
```

### Debug e Logs

**Adicionar logging**:
```python
import logging

logging.basicConfig(
    level=logging.DEBUG,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    filename='conciliador.log'
)

logger = logging.getLogger(__name__)
logger.debug("Iniciando processamento...")
```

### Performance

**Otimizar processamento de grandes planilhas**:
```python
# Processar em chunks
for chunk in pd.read_excel('grande_arquivo.xlsx', chunksize=1000):
    transactions, erros = extrair_transactions(chunk)
    # processar...
```

---

## Roadmap

### v2.0.0 (Atual - Em Desenvolvimento)
- [x] Refatora√ß√£o completa da arquitetura
- [x] Separa√ß√£o Models/Services/UI
- [ ] Sistema de valida√ß√£o robusto
- [ ] M√∫ltiplos templates
- [ ] Interface modernizada

### v2.1.0 (Planejado)
- [ ] Suporte a CSV
- [ ] Exporta√ß√£o para PDF
- [ ] Relat√≥rios estat√≠sticos
- [ ] Configura√ß√µes por template

### v2.2.0 (Futuro)
- [ ] API REST
- [ ] Dashboard web
- [ ] Integra√ß√£o com APIs banc√°rias
- [ ] Machine Learning para classifica√ß√£o

---

## Refer√™ncias

### Bibliotecas Utilizadas

- [Pandas](https://pandas.pydata.org/docs/) - Manipula√ß√£o de dados
- [OpenPyXL](https://openpyxl.readthedocs.io/) - Processamento Excel
- [CustomTkinter](https://customtkinter.tomschimansky.com/) - Interface gr√°fica
- [SQLite](https://www.sqlite.org/docs.html) - Banco de dados

### Padr√µes e Conven√ß√µes

- [PEP 8](https://peps.python.org/pep-0008/) - Style Guide Python
- [Conventional Commits](https://www.conventionalcommits.org/) - Padr√£o de commits
- [SOLID Principles](https://en.wikipedia.org/wiki/SOLID) - Princ√≠pios de design

---

**√öltima atualiza√ß√£o**: 02/10/2025
**Vers√£o da documenta√ß√£o**: 2.0.0
